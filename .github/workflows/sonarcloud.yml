name: SonarCloud

on:
  push:
    branches:
      - main
      - feature/dev
  pull_request:
    branches:
      - main
      - feature/dev
  workflow_dispatch:

permissions:
  pull-requests: read

jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest

    # 1️⃣ DÉFINITION DU SERVICE BDD
    # On lance un conteneur MySQL accessible sur le port 3306 (localhost)
    services:
      mysql:
        image: mysql:8.0
        env:
          # On reprend les identifiants trouvés dans TestsDaoHibernate-context.xml
          # pour minimiser les changements de configuration
          MYSQL_DATABASE: chollet14u_bankiuttest
          MYSQL_USER: chollet14u_appli
          MYSQL_PASSWORD: '32301542' # Mettre entre quotes pour éviter les soucis de parsing
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        # Options pour attendre que MySQL soit prêt avant de lancer les steps
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      # 2️⃣ Checkout
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: .   # clone dans le répertoire de travail racine

      # 3️⃣ Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'
      
      # 4️⃣ INITIALISATION DE LA BDD
      # On injecte le dumpSQL.sql dans la base fraîchement créée
      - name: Initialize Database
        run: |
          mysql -h 127.0.0.1 -u chollet14u_appli -p32301542 chollet14u_bankiuttest < chollet14u_bankiuttest.sql

      # 5️⃣ Cache SonarCloud packages
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # 6️⃣ Cache Maven packages
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('_00_ASBank2023/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # 7️⃣ Build, Test, and Analyze with Maven
      # On combine "verify" (tests) et "sonar:sonar" (analyse)
      # Ainsi, Sonar profite de la compilation et de la BDD déjà prêtes.
      - name: Build and analyze with Maven
        run: |
          mvn -B -f _00_ASBank2023/pom.xml verify sonar:sonar \
            -Dsonar.projectKey=EskYzK_BUT3_QUALDEV_GROUPE3 \
            -Dsonar.organization=eskyzk \
            -Dsonar.host.url=https://sonarcloud.io
        env:
          # Variables pour les Tests (BDD)
          DB_URL: jdbc:mysql://127.0.0.1:3306/chollet14u_bankiuttest?useSSL=false&serverTimezone=UTC
          DB_USER: chollet14u_appli
          DB_PASS: 32301542
          # Variables pour Sonar
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}